#!/usr/bin/env bash

export AUTODEPLOY_MESSAGE="deployment image update from travis_deploy_script"

if [ "${TRAVIS_BRANCH}" != "master" ]; then
    echo " > skipping deployment - branch is not master"
    exit 0
fi

if [ "${TRAVIS_REPO_SLUG}" != "hasadna/knesset-data-pipelines" ]; then
    echo " > Skipping deployment - repo is not hasadna/knesset-data-pipelines"
    exit 0
fi

if [ "${TRAVIS_PULL_REQUEST}" != "false" ]; then
    echo " > skipping deployment - pull request"
    exit 0
fi

if echo "${TRAVIS_COMMIT_MESSAGE}" | grep "${AUTODEPLOY_MESSAGE}" > /dev/null; then
    echo " > skipping deployment - commit is autogenerated by this script - prevent infinite recursion"
    exit 0
fi

if [ "${DEPLOYMENT_BOT_GITHUB_TOKEN}" == "" ] || [ "${SERVICE_ACCOUNT_B64_JSON_SECRET_KEY}" == "" ]; then
    echo " > following environment variables are required for travis deploy: "
    echo " > (they should be created by provision script)"
    echo " > SERVICE_ACCOUNT_B64_JSON_SECRET_KEY"
    echo " > DEPLOYMENT_BOT_GITHUB_TOKEN"
    exit 0
fi

# only production environment is supported at the moment
export K8S_ENVIRONMENT="production"

export GIT_CONFIG_USER="oknesset-deployment-bot"
export GIT_CONFIG_EMAIL="ori+oknesset-deployment-bot@uumpa.com"

echo " > install and authenticate with gcloud"  # based on http://thylong.com/ci/2016/deploying-from-travis-to-gce/

if [ ! -d "$HOME/google-cloud-sdk/bin" ]; then
    rm -rf $HOME/google-cloud-sdk
    curl https://sdk.cloud.google.com | bash
fi

source /home/travis/google-cloud-sdk/path.bash.inc
gcloud version
gcloud --quiet components update kubectl

export CLOUDSDK_CORE_DISABLE_PROMPTS=1
export BUILD_LOCAL=1

bin/k8s_continuous_deployment.sh || exit 1

echo " > Updating GitHub"
git config user.email "${GIT_CONFIG_EMAIL}"
git config user.name "${GIT_CONFIG_USER}"
git diff devops/k8s/values-production-image-app.yaml
git add devops/k8s/values-production-image-app.yaml
git commit -m "${AUTODEPLOY_MESSAGE}"
git push "https://${DEPLOYMENT_BOT_GITHUB_TOKEN}@github.com/${TRAVIS_REPO_SLUG}.git" "HEAD:${TRAVIS_BRANCH}"


#
#
#echo " > update pipelines app image and commit to git"
#
#pip install pyyaml || pip3 install pyyaml || true
#bin/k8s_update_deployment_image.py "app" "gcr.io/hasadna-oknesset/knesset-data-pipelines:${TRAVIS_COMMIT}"
#git config user.email ori+oknesset-deployment-bot@uumpa.com
#git config user.name oknesset-deployment-bot
#git add "devops/k8s/app.yaml"
#git commit -m "deployment image update: app=gcr.io/hasadna-oknesset/knesset-data-pipelines:${TRAVIS_COMMIT}"
#git push "https://${DEPLOYMENT_BOT_GITHUB_TOKEN}@github.com/hasadna/knesset-data-pipelines.git" HEAD:master
#
#
#echo " > deploy"
#
#bin/k8s_deploy.sh
